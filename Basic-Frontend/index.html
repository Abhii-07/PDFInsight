<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles.css">
    <title>Project Cosmos</title>
    <!-- Add a link to your preferred font -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet">
</head>

<body>
    <header>
        <h1>Project Cosmos</h1>
        <!-- Dark mode toggle switch -->
        <div class="toggle-switch">
            <label>
                <input type="checkbox" id="darkModeToggle">
            </label>
        </div>
    </header>
    <div class="container">
        <!-- File upload input -->
        <div class="file-upload">
            <input type="file" id="pdfInput" accept=".pdf">
            <label for="pdfInput">Upload PDF</label>
            <div class="progress-container">
                <progress id="progressBar" value="0" max="100"></progress>
            </div>
        </div>

        <div class="document-details" id="documentDetails" style="display: none;">
            <div class="document-info">
                <p><strong>Title:</strong> <span id="documentTitle"></span></p>
            </div>
            <button id="removeDocument">Remove</button>
        </div>

        <!-- Chat area -->
        <div class="chat-area">
            <!-- Chat messages will be displayed here -->
            <div class="messages">
                <!-- Sample chat message -->
                <div class="message received">
                    <p>Sample received message</p>
                </div>
                <div class="message sent">
                    <p>Sample sent message</p>
                </div>
            </div>
            <!-- Input field for typing messages -->
            <input type="text" id="messageInput" placeholder="Type a message...">
            <!-- Send button -->
            <button id="sendButton">Send</button>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"
            integrity="sha512-ml/QKfG3+Yes6TwOzQb7aCNtJF4PUyha6R3w8pSTo/VJSywl7ZreYvvtUso7fKevpsI+pYVVwnu82YO0q3V6eg=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

        <script>
            // JavaScript for dark mode toggle
            const darkModeToggle = document.getElementById('darkModeToggle');
            const body = document.body;

            darkModeToggle.addEventListener('change', () => {
                if (darkModeToggle.checked) {
                    body.classList.add('dark-mode');
                } else {
                    body.classList.remove('dark-mode');
                }
            });

            // // JavaScript for handling file upload
            const pdfInput = document.getElementById('pdfInput');
            const progressBar = document.getElementById('progressBar');
            const documentDetails = document.getElementById('documentDetails');
            const documentTitle = document.getElementById('documentTitle');
            const removeDocumentButton = document.getElementById('removeDocument');
            const messagesContainer = document.querySelector('.messages');

            pdfInput.addEventListener('change', handleFileUpload);

            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (file && file.type === 'application/pdf') {
                    // Show progress bar
                    progressBar.style.display = 'block';

                    // Create a FormData object to send the file to the server (replace with actual upload logic)
                    const formData = new FormData();
                    formData.append('pdf', file);

                    // Convert the FormData into a Blob
                    const pdfData = new Blob([formData.get('pdf')], { type: 'application/pdf' });

                    // Convert the Blob into an ArrayBuffer
                    const reader = new FileReader();

                    reader.onload = function (event) {
                        const arrayBuffer = event.target.result;

                        // Simulate a progress update (remove in production)
                        let progress = 0;
                        const interval = setInterval(() => {
                            progress += 10;
                            progressBar.value = progress;
                            if (progress === 100) {
                                clearInterval(interval);
                                // Hide progress bar
                                progressBar.style.display = 'none';

                                // Display document details
                                documentDetails.style.display = 'flex';

                                // Set document title (you can retrieve this from the file)
                                documentTitle.textContent = file.name;

                                // Call the PDF text extraction function with the ArrayBuffer
                                convertPDFToText(arrayBuffer);

                                // Show remove button
                                removeDocumentButton.style.display = 'block';
                            }
                        }, 200); // Simulated progress update every 200 milliseconds
                    };

                    reader.readAsArrayBuffer(pdfData);
                } else {
                    alert('Please upload a valid PDF file.');
                }
            }

            // JavaScript for removing the uploaded document
            removeDocumentButton.addEventListener('click', () => {
                // Hide document details and remove button
                documentDetails.style.display = 'none';
                removeDocumentButton.style.display = 'none';

                // Clear the file input
                pdfInput.value = '';
            });

            // JavaScript for sending chat messages
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            // const messagesContainer = document.querySelector('.messages');

            sendButton.addEventListener('click', sendMessage);

            function sendMessage() {
                const messageText = messageInput.value.trim();
                if (messageText !== '') {
                    // Create a new chat message and append it to the chat area
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('message', 'sent');
                    messageDiv.innerHTML = `<p>${messageText}</p>`;
                    messagesContainer.appendChild(messageDiv);

                    // Clear the input field
                    messageInput.value = '';
                }
            }


            pdfInput.addEventListener('change', handleFileUpload);


            // function handleFileUpload(event) {
            //     const file = event.target.files[0];
            //     if (file && file.type === 'application/pdf') {
            //         // Show progress bar
            //         progressBar.style.display = 'block';

            //         // Create a FormData object to send the file to the server (replace with actual upload logic)
            //         const formData = new FormData();
            //         formData.append('pdf', file);

            //         // Convert the FormData into a Blob
            //         const pdfData = new Blob([formData.get('pdf')], { type: 'application/pdf' });

            //         // Convert the Blob into an ArrayBuffer
            //         const reader = new FileReader();

            //         reader.onload = function (event) {
            //             const arrayBuffer = event.target.result;

            //             // Simulate a progress update (remove in production)
            //             let progress = 0;
            //             const interval = setInterval(() => {
            //                 progress += 10;
            //                 progressBar.value = progress;
            //                 if (progress === 100) {
            //                     clearInterval(interval);
            //                     // Hide progress bar
            //                     progressBar.style.display = 'none';

            //                     // Display document details
            //                     documentDetails.style.display = 'flex';

            //                     // Set document title (you can retrieve this from the file)
            //                     documentTitle.textContent = file.name;

            //                     // Call the PDF text extraction function with the ArrayBuffer
            //                     convertPDFToText(arrayBuffer);

            //                     // Show remove button
            //                     removeDocumentButton.style.display = 'block';
            //                 }
            //             }, 200); // Simulated progress update every 200 milliseconds
            //         };

            //         reader.readAsArrayBuffer(pdfData);
            //     } else {
            //         alert('Please upload a valid PDF file.');
            //     }
            // }

            function sendPDFTextToBackend(pdfText) {
                // Define the endpoint URL for your Django view
                const endpointURL = '/your-backend-endpoint-url/';

                // Create a data object with the extracted PDF text
                const data = {
                    pdf_text: pdfText,
                };

                // Send a POST request to the backend
                fetch(endpointURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                    .then(response => response.json())
                    .then(responseData => {
                        // Handle the response from the backend (if needed)
                        console.log(responseData);
                    })
                    .catch(error => {
                        // Handle errors (e.g., network issues)
                        console.error('Error sending PDF text to the backend:', error);
                    });
            }

            function convertPDFToText(arrayBuffer) {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

                const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });

                loadingTask.promise
                    .then(function (pdf) {
                        let text = '';
                        const numPages = pdf.numPages;

                        async function extractText(pageNum) {
                            let page = await pdf.getPage(pageNum); // Get the page object for each page
                            let txt = await page.getTextContent(); // Get the text content of the page
                            let pageText = txt.items.map((s) => s.str).join(""); // Concatenate the text items into a single string
                            return pageText;
                        }

                        async function processPages() {
                            for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                                const pageText = await extractText(pageNum);
                                text += ' ' + pageText;
                            }
                            displayExtractedText(text);

                            // Log the extracted text to the console
                            console.log(text);

                            sendPDFTextToBackend(text);
                        }

                        processPages();
                    })
                    .catch(function (error) {
                        console.error('Error occurred while loading PDF:', error);
                    });
            }

            function displayExtractedText(text) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', 'received');
                messageDiv.innerHTML = `<p>${text}</p>`;
                messagesContainer.appendChild(messageDiv);
            }

        </script>
</body>

</html>